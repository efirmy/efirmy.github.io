<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matematyczne Bomby</title>
<style>
    body {
        margin: 0;
        overflow: hidden;
        background: linear-gradient(to bottom, #87ceeb, #fefefe);
        font-family: 'Arial', sans-serif;
    }
    #menu {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    button {
        font-size: 20px;
        margin: 5px;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        border: none;
    }
    button:hover {
        background-color: #eeeeee;
    }
    #gameCanvas {
        display: none;
        background: linear-gradient(to bottom, #6ec6ff, #004d99);
    }
    #scoreboard {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 22px;
        color: white;
        text-shadow: 1px 1px 2px black;
    }
    #inputBox {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: none;
    }
    #inputBox input {
        font-size: 20px;
        padding: 5px 10px;
        width: 130px;
        text-align: center;
        border-radius: 5px;
        border: 1px solid #888;
    }
    #micBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 18px;
        background-color: #ffcc00;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        display: none;
        transition: 0.2s;
    }
    #micBtn.active {
        background-color: #00cc66;
        color: white;
    }
</style>
</head>
<body>

<div id="menu">
    <h1>?? Matematyczne Bomby ??</h1>
    <p>Wybierz poziom trudnoœci (1–5):</p>
    <div id="difficultyButtons"></div>
</div>

<div id="scoreboard">Punkty: 0</div>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<button id="micBtn">?? W³¹cz mikrofon</button>

<div id="inputBox">
    <input type="number" id="answerInput" placeholder="Wpisz wynik" />
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let bombs = [];
let gameActive = false;
let difficulty = 1;
let recognition;
let score = 0;
let fallSpeed = 1;
let spawnDelay = 3000;
const micBtn = document.getElementById('micBtn');

// Tworzenie przycisków poziomów
const diffContainer = document.getElementById('difficultyButtons');
for (let i = 1; i <= 5; i++) {
    const btn = document.createElement('button');
    btn.textContent = `Poziom ${i}`;
    btn.onclick = () => startGame(i);
    diffContainer.appendChild(btn);
}

// Start gry
function startGame(level) {
    difficulty = level;
    document.getElementById('menu').style.display = 'none';
    canvas.style.display = 'block';
    document.getElementById('inputBox').style.display = 'block';
    micBtn.style.display = 'block';
    gameActive = true;
    score = 0;
    updateScore();
    adjustDifficulty(level);
    prepareMicPermission();
    spawnBomb();
    gameLoop();
}

// Dopasowanie trudnoœci
function adjustDifficulty(level) {
    const speeds = [1, 2, 3, 4, 5]; // px/frame
    const spawnRates = [4000, 3000, 2000, 1500, 1000]; // ms
    fallSpeed = speeds[level - 1];
    spawnDelay = spawnRates[level - 1];
}

// Tworzenie nowej bomby
function spawnBomb() {
    if (!gameActive) return;
    const a = Math.floor(Math.random() * 10 * difficulty) + 1;
    const b = Math.floor(Math.random() * 10 * difficulty) + 1;
    const bomb = {
        x: Math.random() * (canvas.width - 80) + 40,
        y: -50,
        a, b,
        answer: a * b,
        exploded: false,
        color: 'black'
    };
    bombs.push(bomb);
    setTimeout(spawnBomb, spawnDelay);
}

// G³ówna pêtla gry
function gameLoop() {
    if (!gameActive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBombs();
    updateBombs();
    requestAnimationFrame(gameLoop);
}

// Rysowanie bomb
function drawBombs() {
    bombs.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 30, 0, Math.PI * 2);
        ctx.fillStyle = b.color;
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${b.a}·${b.b}`, b.x, b.y + 7); // u¿ycie czytelnego znaku mno¿enia „·”
    });
}

// Aktualizacja pozycji bomb
function updateBombs() {
    bombs.forEach(b => {
        b.y += fallSpeed;
        if (b.y >= canvas.height - 30 && !b.exploded) {
            b.color = 'gray'; // spada bez wybuchu
        }
        if (b.y > canvas.height + 30) {
            bombs = bombs.filter(x => x !== b);
        }
    });
}

// Wymuszenie zgody na mikrofon (Android-friendly)
function prepareMicPermission() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => console.log('Dostêp do mikrofonu OK'))
            .catch(err => console.warn('Brak zgody na mikrofon:', err));
    }
}

// Aktywacja rozpoznawania mowy po klikniêciu
micBtn.addEventListener('click', () => {
    if (recognition && micBtn.classList.contains('active')) {
        recognition.stop();
        micBtn.classList.remove('active');
        micBtn.textContent = '?? W³¹cz mikrofon';
    } else {
        initSpeechRecognition();
        micBtn.classList.add('active');
        micBtn.textContent = '??? Nas³uchujê...';
    }
});

// Inicjalizacja rozpoznawania mowy
function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert('Twoja przegl¹darka nie obs³uguje rozpoznawania mowy.');
        return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'pl-PL';
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = e => {
        const transcript = e.results[e.results.length - 1][0].transcript.trim();
        const number = parseInt(transcript.replace(/\D/g, ''));
        if (!isNaN(number)) checkAnswer(number);
    };

    recognition.onend = () => {
        if (micBtn.classList.contains('active')) recognition.start(); // ponowne uruchomienie
    };

    recognition.start();
}

// Sprawdzenie odpowiedzi
function checkAnswer(value) {
    for (let b of bombs) {
        if (!b.exploded && b.answer === value) {
            b.exploded = true;
            score++;
            updateScore();
            explode(b);
            return;
        }
    }
}

// Efekt wybuchu
function explode(bomb) {
    bomb.color = 'orange';
    const interval = setInterval(() => {
        bomb.color = bomb.color === 'orange' ? 'red' : 'yellow';
    }, 100);
    setTimeout(() => {
        clearInterval(interval);
        bombs = bombs.filter(x => x !== bomb);
    }, 400);
}

// Obs³uga klawiatury
document.getElementById('answerInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        const val = parseInt(e.target.value);
        if (!isNaN(val)) checkAnswer(val);
        e.target.value = '';
    }
});

// Aktualizacja punktów
function updateScore() {
    document.getElementById('scoreboard').textContent = `Punkty: ${score}`;
}
</script>
</body>
</html>
